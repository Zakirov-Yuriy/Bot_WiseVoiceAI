# Миграция с SQLite на MySQL для Railway

Этот документ описывает процесс перехода с SQLite на MySQL для развертывания на Railway.

## Предварительные требования

1. Установите MySQL зависимости:
```bash
pip install aiomysql pymysql cryptography sqlalchemy
```

2. Создайте базу данных MySQL на Railway:
   - Перейдите в панель управления Railway
   - Добавьте MySQL базу данных
   - Скопируйте DATABASE_URL из переменных окружения

## Шаги миграции

### 1. Настройка переменных окружения

✅ **Уже настроено!** В файле `.env` уже добавлен DATABASE_URL для вашей Railway MySQL базы данных:

```env
DATABASE_URL=mysql+pymysql://root:ZNvVFQHtYaywuYLwBDXOIzhSkQAuvQcN@interchange.proxy.rlwy.net:32523/railway
```

Если вы хотите использовать другие параметры, замените на соответствующие значения из Railway.

### 2. Создание схемы базы данных

Примените миграцию Alembic для создания таблиц:

```bash
alembic upgrade head
```

### 3. Миграция данных

Запустите скрипт миграции данных из SQLite в MySQL:

```bash
python migrate_to_mysql.py
```

Скрипт прочитает данные из `users.db.backup` и перенесет их в MySQL базу данных.

### 4. Тестирование подключения

Сначала протестируйте подключение к MySQL:

```bash
python test_mysql_connection.py
```

Это создаст тестового пользователя и проверит основные операции с базой данных.

### 5. Миграция данных

Запустите скрипт миграции данных из SQLite в MySQL:

```bash
python migrate_to_mysql.py
```

Скрипт прочитает данные из `users.db.backup` и перенесет их в MySQL базу данных.

### 6. Финальная проверка

Проверьте, что данные успешно перенесены:

```bash
# Можно использовать простой Python скрипт для проверки
python -c "
import asyncio
from src.database import get_user_data
from src.config import DATABASE_URL
print('DATABASE_URL:', DATABASE_URL)
# Здесь можно добавить код для проверки данных
"
```

## Структура изменений

### Измененные файлы:

1. **requirements.txt** - добавлены MySQL зависимости
2. **src/config.py** - добавлена настройка DATABASE_URL
3. **src/database.py** - полный рефакторинг для использования SQLAlchemy с MySQL
4. **alembic.ini** - изменена конфигурация для MySQL
5. **alembic/env.py** - обновлена для использования DATABASE_URL
6. **.env** - добавлена переменная DATABASE_URL

### Новые файлы:

1. **alembic/versions/9c3ba1a2bbd2_initial_migration_to_mysql.py** - миграция для создания схемы
2. **migrate_to_mysql.py** - скрипт для переноса данных
3. **test_mysql_connection.py** - скрипт для тестирования подключения к MySQL
4. **MIGRATION_README.md** - этот файл с инструкциями

## Важные замечания

1. **Резервное копирование**: Убедитесь, что `users.db.backup` содержит актуальные данные
2. **Тестирование**: Перед развертыванием на Railway thoroughly протестируйте приложение локально
3. **Переменные окружения**: На Railway установите DATABASE_URL в переменных окружения проекта
4. **Автоматическая миграция**: Alembic будет автоматически применять миграции при развертывании

## Возможные проблемы

### Ошибка подключения к MySQL
- Проверьте корректность DATABASE_URL
- Убедитесь, что MySQL сервер доступен
- Проверьте firewall и сетевые настройки

### Ошибки миграции данных
- Проверьте, что users.db.backup существует и содержит данные
- Убедитесь, что структура данных совместима
- Проверьте логи на наличие ошибок

### Проблемы с Alembic
- Убедитесь, что все миграции применены: `alembic current`
- Проверьте статус миграций: `alembic history`

## После миграции

1. Удалите старые SQLite файлы (`users.db`, `users.db.backup`)
2. Обновите документацию и код, убрав ссылки на SQLite
3. Протестируйте все функции приложения
4. Разверните на Railway с новыми переменными окружения
